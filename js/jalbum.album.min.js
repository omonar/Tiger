var J={ALBUM:"album",FOLDERS:"folders",NAME:"name",PATH:"path",THUMB:"thumb",IMAGE:"image",WIDTH:"width",HEIGHT:"height",ORIGINAL:"original",FOLDERS:"folders",OBJECTS:"objects",FILEDATE:"fileDate",COMMENT:"comment",TITLE:"title",COUNTERS:"counters",DEEPCOUNTERS:"deepCounters",FILESIZE:"fileSize",CATEGORY:"category",KEYWORDS:"keywords",CAMERA:"camera",VIDEO:"video",LEVEL:"level",PATHREF:"pathRef",PARENTREF:"parentRef",RELPATH:"relPath",FOLDERTITLE:"folderTitle",IMAGECAPTION:"imageCaption",THUMBCAPTION:"thumbCaption",PHOTODATA:"photodata",LOCATION:"location",REGIONS:"regions",SHOP:"shop",EXTERNAL:"external",PROJECTIONTYPE:"projectionType",DATES:"dates",ADDED:"added",TAKENDATE:"takenDate",MODIFIEDDATE:"modifiedDate",DATERANGE:"dateRange",MOSTPHOTOS:"mostphotos",SOUNDCLIP:"soundClip",FILTERDATA:"filterData",OBJ:"obj",LOADCOUNTER:"loadcounter",TOTAL:"total",INDEX:"index"},Album=function(e,t){var n,r,o,a,l,s={treeFile:"tree.json",dataFile:"data1.json",deepDataFile:"deep-data.json",indexName:"index.html",folderImageFile:"folderimage.jpg",folderImageDims:[1200,800],folderThumbFile:"folderthumb.jpg",folderThumbDims:[600,420],thumbDims:[240,180],slidesDir:"slides",hiresDir:"hi-res",rootPath:"",audioPoster:"audio.png",videoPoster:"video.png",relPath:"",loadDeep:!1,lazy:!0,possibleTypes:["folder","webPage","webLocation","image","video","audio","other"]},u=getTranslations({and:"and"}),f={},c=[],h=[],E=function(e){if("video"===e[J.CATEGORY]){var t=e[J.VIDEO][J.PATH];return decodeURIComponent(t.substring(t.lastIndexOf("/")+1))}return e.hasOwnProperty(J.ORIGINAL)?decodeURIComponent(e[J.ORIGINAL][J.PATH].replace(s.hiresDir+"/","")):e[J.NAME]},O=function(e){return e.hasOwnProperty(J.CATEGORY)&&-1!=="image.video.audio.other".indexOf(e[J.CATEGORY])},d=function(t){if(!t)return 0;"/"===t.slice(-1)&&"../"!==t.slice(-3)&&(t=t.substring(0,t.length-1));var n=e.inArray(t,c);return n>=0?n+1:c.push(t)},p=function(e){return e?c[e-1]:""},T=function(t){return t?(t--,!e.isNumeric(t)||t<0||t>c.length?(console.log("Error: out of bounds path reference ("+t+")!"),null):P(c[t])):f},g=function(e,t){if(e.hasOwnProperty(J.FOLDERS))for(var n=0,r=e[J.FOLDERS].length;n<r;n++)if(e[J.FOLDERS][n][J.PATH]===t)return e[J.FOLDERS][n];return null},P=function(e){for(var t,n=f,r=e.split("/"),o=0,a=r.length;o<a;o++){if(!(t=g(n,r[o])))return null;n=t}return o===a?n:null},A=function(e){if(typeof e===UNDEF&&(e=r),e===f)return null;var t;return(t=T(e.hasOwnProperty(J.PARENTREF)?e[J.PARENTREF]:e[J.PATHREF]))===e?null:t},D=function(t,n){var r={};do{t.hasOwnProperty(n)&&(r=e.extend({},t[n],r))}while(t=A(t));return r},R=function(e,t){if(t)for(var n in e)n===J.OBJECTS||n===J.ALBUM||t.hasOwnProperty(n)||(t[n]=e[n])},y=function(e,t,n){if(e.hasOwnProperty(J.OBJECTS)){t[J.OBJECTS]=[];for(var r,o=0,a=0,i=e[J.OBJECTS].length;o<i;o++)r=e[J.OBJECTS][o],f[J.LOADCOUNTER][r[J.CATEGORY]]++,f[J.LOADCOUNTER][J.TOTAL]++,"folder"===r[J.CATEGORY]?(t[J.FOLDERS]||(t[J.FOLDERS]=[]),R(r,t[J.FOLDERS][a]),n&&y(r,t[J.FOLDERS][a],!0),(r={})[J.INDEX]=a,a++):(r[J.PATHREF]=t[J.PATHREF],r[J.RELPATH]=t[J.RELPATH]),t[J.OBJECTS].push(r)}},m=function(t,n){if(t){if(t.hasOwnProperty(J.OBJECTS))return e.isFunction(n)&&n.call(this,t),!0;var r=p(t[J.RELPATH]);h||(h=[]),h.push(e.getJSON((r?r+"/":"")+s.dataFile+(s.makeDate?"?"+s.makeDate:"")).done(function(r){R(r,t),y(r,t),e.isFunction(n)&&n.call(this,t)}).fail(function(){console.log('Error loading folder data: "'+(r?r+"/":"")+s.dataFile+'".'),e.isFunction(n)&&n.call(this,t)}))}},L=function(e,t){if(m(e),t&&e.hasOwnProperty(J.FOLDERS))for(var n=0,r=e[J.FOLDERS].length;n<r;n++)L(e[J.FOLDERS][n])},F=function(e){return typeof e===UNDEF&&(e=r),e===f?0:e.hasOwnProperty(J.LEVEL)?e[J.LEVEL]:F(A(e))},w=function(e,t,n){return n?function(e,t){if(t.indexOf(".")>=0){if("album"===(t=t.split("."))[0])return S(t[1]);do{if(e.hasOwnProperty(t[0]))return e[t[0]][t[1]]}while(e=A(e));return null}do{if(e.hasOwnProperty(t))return e[t]}while(e=A(e));return null}(e,t):t.indexOf(".")>0?(t=t.split("."),e.hasOwnProperty(t[0])?e[t[0]][t[1]]:null):e[t]},S=function(e){return f.hasOwnProperty(e)?f[e]:null},v=function(t){var n=e("<div>").css({position:"fixed",width:"80%",maxWidth:"600px",top:"50%",left:"50%",transform:"translate(-50%, -50%)",textAlign:"center",padding:"1em",backgroundColor:"#a00",color:"#e8e8e8"}).append(e("<h5>",{text:"Error"}).css({color:"#f63"})).append(e("<p>",{html:t}).css({marginBottom:0})).appendTo(e("body"));n.find("a").css({color:"#fff",textDecoration:"underline"}),setTimeout(function(){n.fadeOut(function(){n.remove()})},6e3)};return t&&(DEBUG&&console.log("new Album("+JSON.stringify(t)+");"),function(t){if(n)return n;n=new Date,typeof t!==UNDEF&&e.extend(s,t),a=l=!1,"."===s.rootPath&&(s.rootPath="");(function(t){e.getJSON((s.rootPath?s.rootPath+"/":"")+s.treeFile+(s.makeDate?"?"+s.makeDate:"")).done(function(n){(f=n)[J.LOADCOUNTER]={},f[J.LOADCOUNTER][J.TOTAL]=0;for(var o=0;o<s.possibleTypes.length;o++)f[J.LOADCOUNTER][s.possibleTypes[o]]=0;null===(r=function(e){return e?("/"===e.slice(-1)&&(e=e.slice(0,-1)),P(e)):f}(s.relPath))&&(console.log("Error: can't find folder \""+s.relPath+'" in the database!'),v((location.protocol,'Check if you\'ve allowed jAlbum to process the subdirectories and "Make album" again!'))),function(){var e=function(t,n,o){t[J.LEVEL]=n,t.hasOwnProperty(J.CATEGORY)||(t[J.CATEGORY]="folder"),o=o.length&&"/"!==o.slice(-1)?o+"/":o;var a=n?t[J.PATH]:"";t[J.PATHREF]=d(o+a),t[J.PARENTREF]=n?d(o):null;var i;if(i=s.relPath.length?t===r?"":0===o.indexOf(a+"/")?a.substring(s.relPath.length):s.rootPath+"/"+(o+a):o+a,t[J.RELPATH]=d(i),t.hasOwnProperty(J.FOLDERS)){pr=d(o);for(var l=0,u=t[J.FOLDERS].length;l<u;l++)e(t[J.FOLDERS][l],n+1,o+a)}};e(f,0,"")}(),e.isFunction(t)&&t.call(this)}).fail(function(){console.log('Fatal error! Missing or access denied to "'+s.treeFile+'".'),v("file:"===location.protocol?'Local access to the album\'s database file is blocked by your browser. This will not affect the uploaded album! Use jAlbum\'s built-in browser or FireFox for testing, or <a href="https://jalbum.net/forum/ann.jspa?annID=172" target="_blank">read here</a> how to test albums in other browsers!':"The album's main database file is missing or broken! If you're the owner <a href=\"https://jalbum.net/forum/ann.jspa?annID=177\">read how you can fix this</a>."),e.isFunction(t)&&t.call(this)})})(function(){h=[],L(s.lazy?r:f,!s.lazy),e.when.apply(e,h).done(function(){var t=new Date;DEBUG&&console.log(h.length+" folder(s) loaded: "+(t-n)+"ms"),a=!0,h=null,o=r&&r.hasOwnProperty(J.OBJECTS)?0:null,e.isFunction(s.ready)&&s.ready.call(this),s.loadDeep&&f.hasOwnProperty(J.FOLDERS)?function(){var t=new Date,n=(s.rootPath?s.rootPath+"/":"")+s.deepDataFile+(s.makeDate?"?"+s.makeDate:"");e.getJSON(n).done(function(n){y(n,f,!0),l=!0,DEBUG&&console.log("Deep data loaded: "+(new Date-t)+"ms total: "+f[J.LOADCOUNTER][J.TOTAL]+" objects"),e.isFunction(s.deepReady)&&s.deepReady.call(this)}).fail(function(){l=!1,DEBUG&&console.log('Error loading deep data: "'+n+'".'),e.isFunction(s.deepReady)&&s.deepReady.call(this)})}():e.isFunction(s.deepReady)&&s.deepReady.call(this)})})}(t)),{isReady:function(){return a},collectTags:function(t){var t=e.extend({fields:"creator,keywords,folder:title,webLocation:title",types:"all",depth:"current",exact:"creator,keywords,name"},t),n=[],o=e.isArray(t.fields)?t.fields:t.fields.split(/,\s?/),a=o.length,i="name"===t.sort,l="all"===t.types,u={},c={},E=function(e){for(var t=0,r=!1,o=(e=e.split("^")).length;t<o;t++)if(!(e[t].length<3)){tag=e[t].toUpperCase(),r=!1;for(var a=0,i=n.length;a<i;a++)if(tag===n[a][2]){n[a][1]++,r=!0;break}r||n.push([e[t],1,tag])}},O=function(t,n){for(var r,i="^",l="^",s=function(e,t){if(e){var n,r;c[t]?r=[e.toString()]:("comment"===t&&(e=e.stripHTML()),r=e.split(/\W+/),r=removeEmpty(r));for(var o=0,a=r.length;o<a;o++)(n=r[o].trim()).length<=2||-1===l.indexOf("^"+n.toUpperCase()+"^")&&(i+=n+"^",l+=n.toUpperCase()+"^")}},u=0;u<a;u++){if(o[u].length>1){if(o[u][0]!==n)continue;r=o[u][1]}else r=o[u][0];if(t.hasOwnProperty(r)&&t[r])if(e.isArray(t[r]))for(var f=0;f<t[r].length;f++)s(t[r][f],r);else s(t[r],r)}i.length>1&&E(i)},d=function(e){if(e&&((l||u.folder)&&O(e,"folder"),e.hasOwnProperty(J.OBJECTS)))for(var t,n=0,r=e[J.OBJECTS];n<r.length;n++)r[n].hasOwnProperty(J.CATEGORY)&&(t=r[n][J.CATEGORY],(l||u[t])&&O(r[n],t))},p=function(e){if(m(e,d),"current"!==t.depth&&e.hasOwnProperty(J.FOLDERS))for(var n=0,r=e[J.FOLDERS].length;n<r;n++)p(e[J.FOLDERS][n])},T=function(){t.sort&&n.sort(function(e,t){return i?(""+e[2]).localeCompare(""+t[2]):t[1]-e[1]}),t.max&&t.max<n.length&&(n=n.slice(0,t.max))};h=[];for(var g,P=0;P<a;P++)o[P]=o[P].split(":"),g=o[P][1]||o[P][0],c[g]="string"==typeof t.exact?t.exact.indexOf(g)>=0:t.exact;if(!l)for(var P=0,A=s.types.split(/,\s?/);P<A.length;P++)u[A[P]]=!0;p("tree"===t.depth?f:r),e.isFunction(t.ready)&&(h.length?e.when.apply(e,h).done(function(){T(),t.ready.call(n,t)}):(T(),t.ready.call(n,t)))},collectItems:function(t){if(typeof t!==UNDEF&&t.hasOwnProperty("terms")){var n,o,a=[],i=(t=e.extend({fields:"creator,keywords,title,comment,name",types:"all",depth:"current",exact:!1},t)).fields.split(/,\s?/),l=i.length,c=new Array(l),E=!1,O="all"===t.types,d={},p=function(t,r){for(var s,u=0,f=0;f<l;f++){if(i[f].length>1){if(i[f][0]!==r)continue;s=i[f][1]}else s=i[f][0];t.hasOwnProperty(s)&&(e.isArray(t[s])?t[s].join(" "):t[s]+"").searchTerm(n,c[s],E)&&u++}(E&&u===o||u)&&a.push(t)},T=function(e){if(e&&(e!==f&&(O||d.folder)&&p(e,"folder"),e.hasOwnProperty(J.OBJECTS)))for(var t=0,n=e[J.OBJECTS];t<n.length;t++)n[t].hasOwnProperty(J.CATEGORY)&&(cat=n[t][J.CATEGORY],(O||d[cat])&&p(n[t],cat))},g=function(e){if(m(e,T),"current"!==t.depth&&e.hasOwnProperty(J.FOLDERS))for(var n=0,r=e[J.FOLDERS].length;n<r;n++)g(e[J.FOLDERS][n])},P=function(){t.max&&t.max<a.length&&(a=a.slice(0,t.max))};'"'===t.terms[0]&&'"'===t.terms[t.terms.length-1]?(n=t.terms.substring(1,t.terms.length-1),!1===t.exact&&(t.exact=!0)):!1===t.exact?~(n=t.terms.replace(/\s+/g,",")).indexOf(","+u.and+",")&&(n=n.replace(new RegExp(","+u.and+",","gi"),","),E=!0):n=t.terms.trim(),n=t.exact?[n]:removeEmpty(n.split(/,\s?/)),o=n.length;for(var A,D=0;D<l;D++)i[D]=i[D].split(":"),A=i[D][1]||i[D][0],c[A]="string"==typeof t.exact?t.exact.indexOf(A)>=0:t.exact;if(!O)if("-"===s.types.charAt(0))for(D=0;D<s.possibleTypes.length;D++)-1===s.types.indexOf(s.possibleTypes[D])&&(d[s.possibleTypes[D]]=!0);else for(var D=0,R=s.types.split(/,\s?/);D<R.length;D++)d[R[D]]=!0;h=[],g("tree"===t.depth?f:r),e.isFunction(t.ready)&&(h.length?e.when.apply(e,h).done(function(){P(),t.ready.call(a,t)}):(P(),t.ready.call(a,t)))}},collectByDate:function(t){if(typeof t!==UNDEF&&t.hasOwnProperty("range")&&t.hasOwnProperty("ready")){var n,o,a=[],i=function(e){if(e&&e.hasOwnProperty(J.OBJECTS))for(var r,i,l=e[J.OBJECTS],s=0;s<l.length;s++)!(r=l[s]).hasOwnProperty(J.INDEX)&&O(r)&&(i=r[J.DATES])&&(i=i[t.reference])&&i>=n&&i<=o&&a.push(r)},l=function(e){if(m(e,i),"current"!==t.depth&&e.hasOwnProperty(J.FOLDERS))for(var n=0,r=e[J.FOLDERS].length;n<r;n++)l(e[J.FOLDERS][n])},s=function(){if(t.sort){var e,n;a.sort(function(r,o){return e=r[J.DATES][t.reference],n=o[J.DATES][t.reference],t.reverse?n-e:e-n})}t.max&&t.max<a.length&&(a=a.slice(0,t.max))};(t=e.extend({sort:!0,reverse:!1,reference:"dateTaken",depth:"current"},t)).end?(o=t.end*ONEDAY_S,n=(t.end-t.range)*ONEDAY_S):(n=o=Math.round(new Date/1e3),t.hasOwnProperty("start")?(n-=t.start*ONEDAY_S,o=n+t.range*ONEDAY_S):n-=t.range*ONEDAY_S),h=[],l("tree"===t.depth?f:r),e.isFunction(t.ready)&&(h.length?e.when.apply(e,h).done(function(){s(),t.ready.call(a,t)}):(s(),t.ready.call(a,t)))}},getTree:function(){return f},getPaths:function(){return c},isImage:function(e){return e.hasOwnProperty(J.CATEGORY)&&"image"===e[J.CATEGORY]},isAudio:function(e){return e.hasOwnProperty(J.CATEGORY)&&"audio"===e[J.CATEGORY]},isVideo:function(e){return e.hasOwnProperty(J.CATEGORY)&&"video"===e[J.CATEGORY]},isLightboxable:O,isCurrentFolder:function(e){return 0===e[J.RELPATH]},getLevel:F,getTitle:function(e){return typeof e===UNDEF&&(e=r),e[J.TITLE]||""},getName:function(e){return typeof e===UNDEF&&(e=r),e[J.NAME]||""},getExtension:function(e){return E(e).getExt()},getComment:function(e){return typeof e===UNDEF&&(e=r),e[J.COMMENT]||""},getMakeDate:function(){return new Date(f[J.FILEDATE])},getAlbumTitle:function(){return f[J.TITLE]||f[J.NAME]},getCurrentFolder:function(){return r},getObjects:function(){return r.hasOwnProperty(J.OBJECTS)?r[J.OBJECTS]:[]},getImages:function(){var e=[];if(r&&r.hasOwnProperty(J.OBJECTS)){var t=r[J.OBJECTS];if(t)for(var n=0,o=t.length;n<o;n++)!t[n].hasOwnProperty(J.INDEX)&&O(t[n])&&e.push(t[n])}return e},getFolders:function(){var e=[];if(r)if(r.hasOwnProperty(J.FOLDERIDX))for(var t=0,n=r[J.FOLDERIDX].length;t<n;t++)e.push(r[J.OBJECTS][r[J.FOLDERIDX][t]]);else r.hasOwnProperty(J.FOLDERS)&&(e=r[J.FOLDERS]);return e},getFolderPath:function(e){return p(e[J.PATHREF]||0)},getRelativeFolderPath:function(e){return p(e[J.RELPATH]||0)},getParent:A,getItem:function(t,n){var r,o=function(e,t){if(e.hasOwnProperty(J.OBJECTS))for(var n=e[J.OBJECTS],o=0,a=n.length;o<a;o++)if(n[o][J.NAME]===t)return void(r=n[o])};if(!t)return f;if(t.endsWith("/"))return P(t);var a=t.lastIndexOf("/"),i=P(t.substring(0,a)),l=t.substring(a+1);return i&&(i.hasOwnProperty(J.OBJECTS)?(o(i,l),n.call(r)):(h=[],m(i,o),e.isFunction(n)&&(h.length?e.when.apply(e,h).done(function(){n.call(r)}):n.call(r)))),null},getRootPath:function(e){return p(e[J.PATHREF])+"/"+e[J.NAME]},getItemName:E,getItemPath:function(e){var t=p(e[J.RELPATH]),n=e[J.CATEGORY]||"folder";return t=t.length&&"/"!==t.slice(-1)?t+"/":t,"folder"===n?t:"video"===n?t+e[J.VIDEO][J.PATH]:"audio"===n||"other"===n||e.hasOwnProperty(J.ORIGINAL)?t+e[J.ORIGINAL][J.PATH]:"image"===n?t+e[J.IMAGE][J.PATH]:"webPage"===n?t+e[J.NAME]:e[J.PATH]},getOptimalImage:function(e,t){var n=p(e[J.RELPATH]),r=e[J.CATEGORY]||"folder";return n=n.length&&"/"!==n.slice(-1)?n+"/":n,"folder"===r?n+(t[0]>s.folderThumbDims[0]||t[1]>s.folderThumbDims[1])?s.folderImageFile:s.folderThumbFile:n+(t[0]>s.thumbDims[0]||t[1]>s.thumbDims[1])?e[J.IMAGE][J.PATH]:e[J.THUMB][J.PATH]},getOriginalPath:function(e){if(e.hasOwnProperty(J.ORIGINAL)){var t=p(e[J.RELPATH]);return(t=t.length?t+"/":"")+e[J.ORIGINAL][J.PATH]}if(e.hasOwnProperty(J.CATEGORY)&&e[J.CATEGORY]==="image"){return "/s3/photos/"+getFolderPath(e)+"/"+getName(e)}return null},getUrl:function(e){var t=p((e=e||r)[J.RELPATH]);return t=(t.length?t+"/":"")+s.indexName,O(e[i])&&(t+="#img="+encodeAsJave(e[J.NAME])),t},getThumbPath:function(e){var t=p(e[J.RELPATH]),n=e[J.THUMB][J.PATH];return function(e){return e.hasOwnProperty(J.LEVEL)}(e)&&(n=n.replace(e[J.PATH]+"/","")),(t.length?t+"/":"")+n},getImagePath:function(e){var t=p(e[J.RELPATH]);return(t=t.length?t+"/":"")+e[J.IMAGE][J.PATH]},getThemeImagePath:function(e){var t=p(e[J.RELPATH]);return(t=t.length?t+"/":"")+s.folderImageFile},getPosterPath:function(e){var t=p(e[J.RELPATH]),n=e[J.CATEGORY]||"folder";return t=t.length?t+"/":"","audio"!==n&&"video"!==n||e[J.IMAGE][J.PATH].startsWith(s.slidesDir+"/")?t+e[J.IMAGE][J.PATH]:(s.rootPath.length?s.rootPath+"/":"")+"res/"+s[n+"Poster"]},getSourcePath:function(e){var t=p(e[J.RELPATH]);return(t.length?t+"/":"")+(e.hasOwnProperty(J.ORIGINAL)?e[J.ORIGINAL][J.PATH]:e[J.IMAGE][J.PATH])},getAbsolutePath:function(e){var t=p(e[J.RELPATH]);return(t.length?t.fullUrl():window.location.href.getDir())+(window.location.href.getFile()||s.indexName)+(e.hasOwnProperty(J.LEVEL)?"":"#img="+encodeURIComponent(E(e)))},getAbsoluteImagePath:function(e){var t=p(e[J.RELPATH]);return(t.length?t.fullUrl():window.location.href.getDir())+e[J.IMAGE][J.PATH]},getPreviousFoldersLastImage:function(t){var n,o=function(e){typeof e===UNDEF&&(e=r);var t=A(e);if(t){var n;if(t.hasOwnProperty(J.FOLDERIDX)){if((n=t[J.FOLDERIDX].findIndex(function(n){return t[J.OBJECTS][n]===e}))>0)return t[J.OBJECTS][t[J.FOLDERIDX][n+1]]}else if(t.hasOwnProperty(J.FOLDERS)&&(n=t[J.FOLDERS].findIndex(function(t){return t===e}))>0)return t[J.FOLDERS][n+1]}return null}();return o&&(o.hasOwnProperty(J.OBJECTS)?(getFirstImage(),t.call(n)):(h=[],m(o,function(e){if(e.hasOwnProperty(J.OBJECTS))for(var t=e[J.OBJECTS],r=t.length-1;r>=0;r--)if(O(t[r]))return void(n=t[r])}),e.isFunction(t)&&(h.length?e.when.apply(e,h).done(function(){t.call(n)}):t.call(n)))),null},getNextFoldersFirstImage:function(t){var n,o=function(e){typeof e===UNDEF&&(e=r);var t=A(e);if(t){var n;if(t.hasOwnProperty(J.FOLDERIDX)){if((n=t[J.FOLDERIDX].findIndex(function(n){return t[J.OBJECTS][n]===e}))<t[J.FOLDERIDX].length)return t[J.OBJECTS][t[J.FOLDERIDX][n+1]]}else if(t.hasOwnProperty(J.FOLDERS)&&(n=t[J.FOLDERS].findIndex(function(t){return t===e}))<t[J.FOLDERS].length)return t[J.FOLDERS][n+1]}return null}(),a=function(e){if(e.hasOwnProperty(J.OBJECTS))for(var t=e[J.OBJECTS],r=0,o=t.length;r<o;r++)if(O(t[r]))return void(n=t[r])};return o&&(o.hasOwnProperty(J.OBJECTS)?(a(),t.call(n)):(h=[],m(o,a),e.isFunction(t)&&(h.length?e.when.apply(e,h).done(function(){t.call(n)}):t.call(n)))),null},getProperty:w,getPropertyObject:function(e,t,n){return n?D(e,t):e.hasOwnProperty(t)?e[t]:null},hasShop:function(e){var t=D(e||f,J.SHOP);return t&&"-"!==t.options},getRootProperty:S,processTemplate:function(e,t){var n,o,t=t||r;if(e&&e.indexOf("${")>0)for(;n=e.match(/\$\{([\w\.]+)\}/);)n[1]&&(o=w(t,n[1],!0)||""),e=e.substring(0,n.index)+o+e.substring(n.index+n[0].length);return e}}};