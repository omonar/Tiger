const J={ALBUM:"album",FOLDERS:"folders",NAME:"name",PATH:"path",THUMB:"thumb",IMAGE:"image",WIDTH:"width",HEIGHT:"height",RENDITIONS:"renditions",ORIGINAL:"original",OBJECTS:"objects",FILEDATE:"fileDate",COMMENT:"comment",TITLE:"title",COUNTERS:"counters",DEEPCOUNTERS:"deepCounters",FILESIZE:"fileSize",CATEGORY:"category",KEYWORDS:"keywords",RATING:"rating",CAMERA:"camera",VIDEO:"video",DURATION:"duration",FPS:"fps",HIDDEN:"hidden",LEVEL:"level",PATHREF:"pathRef",PARENTREF:"parentRef",RELPATH:"relPath",FOLDERCAPTION:"folderCaption",IMAGECAPTION:"imageCaption",THUMBCAPTION:"thumbCaption",PHOTODATA:"photodata",LOCATION:"location",REGIONS:"regions",SHOP:"shop",EXTERNAL:"external",PROJECTIONTYPE:"projectionType",ORIGINALFILE:"originalFile",DATES:"dates",ADDED:"added",TAKENDATE:"takenDate",MODIFIEDDATE:"modifiedDate",DATERANGE:"dateRange",MOSTPHOTOS:"mostphotos",FOTOMOTOCOLLECTION:"fotomotoCollection",SOUNDCLIP:"soundClip",PANORAMA:"panorama",FILTERS:"filters",SORT:"sort",VISITORRATING:"visitorRating",OBJ:"obj",LOADCOUNTER:"loadcounter",TOTAL:"total",FOLDERINDEX:"folderindex",SIZE:"size",CONT:"cont"},JCAMERAFIELDS=["aperture","exposureTime","originalDate","cameraModel","location","focusDistance","focalLength35mm","cameraMake","resolution","isoEquivalent","flash","focalLength"];var Album=function(e,t){let r,n,o=null,a={treeFile:"tree.json",dataFile:"data1.json",deepDataFile:"deep-data.json",indexName:"index.html",folderImageFile:"folderimage.jpg",folderImageDims:[1200,800],folderThumbFile:"folderthumb.jpg",folderThumbDims:[1024,768],thumbDims:[240,180],thumbsDir:"thumbs",slidesDir:"slides",hiresDir:"hi-res",audioPoster:"audio.poster.png",defaultAudioPosterSize:[628,360],videoPoster:"video.poster.png",defaultVideoPosterSize:[628,360],rootPath:"",relPath:"",loadDeep:!1,lazy:!0,possibleTypes:["folder","webPage","webLocation","image","video","audio","other"]},l=getTranslations({and:"and",from:"From {0}"}),s=null,E="",h={},O=[],g=[],u=[],p=!1,c=!1,P=function(e){console&&e&&(e.match(/^Error\:/i)&&console.error("jalbum-album.js "+e),DEBUG&&(e.match(/^Warning\:/i)?console.warn("jalbum-album.js "+e):e.match(/^Info\:/i)?console.info("jalbum-album.js "+e):console.log("jalbum-album.js "+e)))},T=e=>decodeURIComponent(e.slice(e.lastIndexOf("/")+1)),I=e=>{var t=getItemName(e).match(/\.(\w+)$/);return t?t[1]:""},A=e=>!e.hasOwnProperty(J.FOLDERINDEX)&&e.hasOwnProperty(J.CATEGORY)&&-1!=="image.video.audio.other".indexOf(e[J.CATEGORY]),D=function(){if(arguments.length){let e=[];for(let t,r=0;r<arguments.length;r++)(t=arguments[r]).length&&("/"===t?e=[]:("/"===t[0]&&(t=t.slice(1)),"/"===t.slice(-1)&&(t=t.slice(0,-1)),t.length&&e.push(t)));return e.join("/")}return""},y=e=>e.hasOwnProperty(J.PATHREF)&&e[J.PATHREF]?O[e[J.PATHREF]-1]:"";return getRelPathRef=(e=>{if(typeof e===UNDEF||!e)return 0;"/"!==e.slice(-1)&&(e+="/");let t=g.indexOf(e);return t>=0?t+1:g.push(e)}),toRelPath=(e=>e.hasOwnProperty(J.RELPATH)&&e[J.RELPATH]?g[e[J.RELPATH]-1]:""),fixUrl=(e=>{let t,r,n=this+"";for(;(t=n.indexOf("../"))>0;){if(1===t||-1===(r=n.lastIndexOf("/",t-2)))return n.substring(t+3);n=n.substring(0,r)+n.substring(t+2)}return n}),getAlbumPath=(()=>{if(null!==s)return s;let e=window.location.pathname,t=n[J.LEVEL];do{e=e.substring(0,e.lastIndexOf("/")),t-=1}while(t>=0);return e}),getAlbumRootPath=(()=>r),getPath=(e=>typeof e!==UNDEF?null!==s?D(s,y(e)):toRelPath(e):s||""),getFolderPath=(e=>typeof e!==UNDEF?y(e):""),getAbsolutePath=(e=>e.hasOwnProperty(J.LEVEL)?D(s||r,getFolderPath(e)):D(s||r,getFolderPath(e),a.indexName+"#img="+e[J.PATH])),getItemPath=(e=>{let t=getPath(e),r=e[J.CATEGORY]||"folder";return"folder"===r?t:"video"===r?D(t,e[J.VIDEO][J.PATH]):"audio"===r||"other"===r||e.hasOwnProperty(J.ORIGINAL)?D(t,e[J.ORIGINAL][J.PATH]):"image"===r?D(t,e[J.IMAGE][J.PATH]):"webPage"===r?D(t,e[J.PATH]):e[J.PATH]}),getObjectPath=(e=>typeof e!==UNDEF?y(e)+("folder"!==e[J.CATEGORY]?e[J.PATH]:""):null),getDimensions=function(e){if(e.hasOwnProperty(J.EXTERNAL)){let t=e[J.EXTERNAL][J.SIZE];return t?(t=t.split("x"),[t[0],t[1]||Math.round(.75*t[0])]):(t=guessDimensions(e[J.EXTERNAL][J.CONT]))||(e[J.EXTERNAL][J.CONT].includes("vimeo.com")||e[J.EXTERNAL][J.CONT].includes("youtube.com")?(w=1280,(t=e[J.EXTERNAL][J.CONT].match(/.*style="padding(-bottom)?:\s?([\d\.]+)%/))&&t&&t.length>1?[1280,Math.round(w*parseFloat(t[2])/100)]:[1280,720]):[e[J.IMAGE][J.WIDTH],e[J.IMAGE][J.HEIGHT]])}return"audio"===e[J.CATEGORY]&&e[J.IMAGE][J.PATH].endsWith("res/audio.png")?[a.defaultAudioPosterSize[0],a.defaultAudioPosterSize[1]]:"video"===e[J.CATEGORY]?[e[J.VIDEO][J.WIDTH],e[J.VIDEO][J.HEIGHT]]:"other"===e[J.CATEGORY]&&"pdf"===I(e).toLowerCase()?null:a.linkOriginals&&a.hiDpi?[e[J.IMAGE][J.WIDTH]/2,e[J.IMAGE][J.HEIGHT]/2]:[e[J.IMAGE][J.WIDTH],e[J.IMAGE][J.HEIGHT]]},getOriginalDimensions=function(e){return"video"===e[J.CATEGORY]?[e[J.VIDEO][J.WIDTH],e[J.VIDEO][J.HEIGHT]]:e.hasOwnProperty(J.ORIGINAL)?[e[J.ORIGINAL][J.WIDTH],e[J.ORIGINAL][J.HEIGHT]]:null},getMaxDimensions=function(e){let t=getOriginalDimensions(e);if(t)return t;if(e.hasOwnProperty(J.IMAGE)){let r=e[J.IMAGE];if(r.hasOwnProperty(J.RENDITIONS)){t=[r[J.RENDITIONS][0][J.WIDTH],r[J.RENDITIONS][0][J.HEIGHT]];for(let e=1;e<r[J.RENDITIONS].length;e++)r[J.RENDITIONS][e][J.WIDTH]>t[0]&&(t=[r[J.RENDITIONS][e][J.WIDTH],r[J.RENDITIONS][e][J.HEIGHT]]);return t}return[r[J.WIDTH],r[J.HEIGHT]]}return null},getLink=function(e){if(typeof e!==UNDEF)switch(e[J.CATEGORY]){case"folder":return getPath(e);case"webLocation":return e[J.PATH];case"webPage":return D(getPath(e),e[J.PATH]);default:return D(getPath(e),"#img="+e[J.PATH])}return""},getRootPath=(e=>D(getPath(e),e[J.PATH])),getPointer=function(e){return"number"!=typeof e||e<=0?h:--e>O.length?(P("Error: out of bounds path reference ("+e+")!"),null):getFolder(O[e])},getRelativeFolderPath=(e=>(a.rootPath+y(e)).fixUrl()),getFolder=function(e){if(typeof e===UNDEF)return null;if(!e.length)return h;e.endsWith("/")&&(e=e.slice(0,-1));let t,r=h,n=e.split("/");for(t=0;t<n.length;t++)if(!r.hasOwnProperty(J.FOLDERS)||!(r=r[J.FOLDERS].find(function(e){return e[J.PATH]===n[t]})))return null;return t===n.length?r:null},getParent=function(e){if(typeof e===UNDEF&&(e=n),e===h)return null;let t=e.hasOwnProperty(J.PARENTREF)?getPointer(e[J.PARENTREF]):getPointer(e[J.PATHREF]);return t===e?null:t},getItem=function(e,t,r){if(typeof t!==FUNCTION)return;let n=function(e,t,n){if(e.hasOwnProperty(J.OBJECTS)){let o=e[J.OBJECTS].find(function(e){return e[J.PATH]===t});typeof o===UNDEF&&(o=null),typeof r!==UNDEF?n.call(o,r):n.call(o)}};if(e)if(e.endsWith("/"))typeof r!==UNDEF?t.call(getFolder(e),r):t.call(getFolder(e));else{let r=e.lastIndexOf("/"),o=-1===r?h:getFolder(e.substring(0,r)),a=e.substring(r+1);o&&(o.hasOwnProperty(J.OBJECTS)?n(o,a,t):loadData(o,function(e){n(e,a,t)}))}else typeof r!==UNDEF?t.call(h,r):t.call(h);return null},getCurrentFolder=(()=>n),getObjects=(()=>n.hasOwnProperty(J.OBJECTS)?n[J.OBJECTS]:[]),getImages=function(){let e=[];return n&&n.hasOwnProperty(J.OBJECTS)&&n[J.OBJECTS].forEach(t=>{A(t)&&e.push(t)}),e},getFolders=function(){let e=[];if(n){if(n.hasOwnProperty(J.FOLDERINDEX))return n[J.FOLDERINDEX].forEach(t=>{e.push(n[J.OBJECTS][t])}),f;n.hasOwnProperty(J.FOLDERS)&&(e=n[J.FOLDERS])}return e.filter(e=>!e.hasOwnProperty(J.HIDDEN)||!e.hidden)},getMakeDate=(()=>new Date(h[J.FILEDATE])),getAlbumTitle=(()=>h[J.TITLE]||h[J.NAME]),getItemName=(e=>"video"===e[J.CATEGORY]?T(e[J.VIDEO][J.PATH]):e.hasOwnProperty(J.ORIGINAL)?T(e[J.ORIGINAL][J.PATH]):e[J.NAME]),getLevel=(e=>(e=e||n).hasOwnProperty(J.LEVEL)?e[J.LEVEL]:getLevel(getParent(e))),getTitle=(e=>(e||n)[J.TITLE]||""),getName=(e=>(e||n)[J.NAME]||""),getLabel=(e=>((e||n)[J.NAME]||"").replace(/\.\w+$/,"").replace(/_/g," ")),getAlt=(e=>getTitle(e)||getName(e)),getComment=(e=>(e||n)[J.COMMENT]||""),getThumbPath=(e=>D(getPath(e),e.hasOwnProperty(J.LEVEL)?e[J.THUMB][J.PATH].replace(e[J.PATH]+"/",""):e[J.THUMB][J.PATH])),getImagePath=(e=>D(getPath(e),e.hasOwnProperty(J.LEVEL)?e[J.THUMB][J.PATH].replace(a.thumbsDir+"/",a.slidesDir+"/"):e.hasOwnProperty(J.ORIGINALFILE)?e[J.ORIGINALFILE]:e.hasOwnProperty(J.IMAGE)?e[J.IMAGE][J.PATH]:e[J.THUMB][J.PATH])),getAbsoluteImagePath=(e=>D(r,y(e),getImagePath(e))),getThemeImagePath=(e=>D(getPath(e),a.folderImageFile)),getOriginalPath=(e=>e.hasOwnProperty(J.ORIGINALFILE)?D(getPath(e),e[J.ORIGINALFILE]):e.hasOwnProperty(J.ORIGINAL)?D(getPath(e),e[J.ORIGINAL][J.PATH]):((e.hasOwnProperty(J.CATEGORY)&&e[J.CATEGORY]==='image')?'/s3/photos/'+getFolderPath(e)+getName(e):null)),getPosterPath=(e=>{let t=e[J.CATEGORY],r=e[J.IMAGE][J.PATH];return"audio"!==t&&"video"!==t||r.startsWith(a.slidesDir+"/")?D(getPath(e),e[J.IMAGE][J.PATH]):D(a.rootPath,"res",a[t+"Poster"])}),getOptimalImage=((e,t)=>D(getPath(e),e.hasOwnProperty(J.LEVEL)?t[0]>a.folderThumbDims[0]||t[1]>a.folderThumbDims[1]?a.folderImageFile:a.folderThumbFile:e.hasOwnProperty(J.ORIGINALFILE)?e[J.ORIGINALFILE]:e.hasOwnProperty(J.IMAGE)&&(t[0]>a.thumbDims[0]||t[1]>a.thumbDims[1])?e[J.IMAGE][J.PATH]:e[J.THUMB][J.PATH])),getClosestRendition=function(e,t){if(WEBP_LOSSY||(e=e.filter(e=>!e.name.endsWith(".webp"))),e.length>1){let r=t[0]*PIXELRATIO,n=t[1]*PIXELRATIO;e.forEach(e=>{let t=Math.min(r/e.width,n/e.height);e.match=t>1?3*(1-1/t):1-t}),e.sort((e,t)=>e.match-t.match)}return e[0]},getOptimalImagePath=function(e,t,r){if(e.hasOwnProperty(J.LEVEL))return a.folderImageFile;if(e.hasOwnProperty(J.ORIGINALFILE))return D(getPath(e),e[J.ORIGINALFILE]);let n=e[J.IMAGE].hasOwnProperty(J.RENDITIONS)?getClosestRendition(e[J.IMAGE][J.RENDITIONS],t||[window.outerWidth,window.outerHeight]):{width:e[J.IMAGE][J.WIDTH],height:e[J.IMAGE][J.HEIGHT]};return typeof r!==UNDEF&&r&&e.hasOwnProperty(J.ORIGINAL)&&t[0]>n[J.WIDTH]?D(getPath(e),e[J.ORIGINAL][J.PATH]):D(getPath(e),n.hasOwnProperty(J.NAME)?a.slidesDir+"/"+n[J.NAME]:e[J.IMAGE][J.PATH])},getOptimalThumbPath=function(e,t){if(e[J.THUMB].hasOwnProperty(J.RENDITIONS)){let r=getClosestRendition(e[J.THUMB][J.RENDITIONS],t),n=a.thumbsDir;return(t[0]>1.15*r[J.WIDTH]||t[1]>1.15*r[J.HEIGHT])&&(r=getClosestRendition(e[J.IMAGE][J.RENDITIONS],t),n=a.slidesDir),D(getPath(e),n+"/"+r[J.NAME])}return t[0]>1.15*e[J.THUMB][J.WIDTH]||t[1]>1.15*e[J.THUMB][J.HEIGHT]?D(getPath(e),e[J.IMAGE][J.PATH]):D(getPath(e),e[J.THUMB][J.PATH])},getSourcePath=(e=>D(getPath(e),e.hasOwnProperty(J.ORIGINAL)?e[J.ORIGINAL][J.PATH]:e.hasOwnProperty(J.IMAGE)?e[J.IMAGE][J.PATH]:e[J.THUMB][J.PATH])),getAbsoluteItemPath=(e=>D(r,getItemPath(e))),getVideoDuration=function(e){let t,r=e[J.VIDEO];return r&&r.hasOwnProperty(J.DURATION)&&(t=r[J.DURATION].match(/(\d{2})\:(\d{2})\:(\d{2})\.(\d+)/))?parseInt(t[4])+1e3*parseInt(t[3])+6e4*parseInt(t[2])+36e5*parseInt(t[1]):null},hasShop=(e=>{let t=getInheritedPropertyObject(e||h,J.SHOP);return t&&(t.usePrice||"-"!==t.options)}),hasLocation=(e=>e.hasOwnProperty(J.LOCATION)||e.hasOwnProperty(J.CAMERA)&&e[J.CAMERA].hasOwnProperty(J.LOCATION)),getLocation=(e=>e.hasOwnProperty(J.LOCATION)?e[J.LOCATION]:e.hasOwnProperty(J.CAMERA)&&e[J.CAMERA].hasOwnProperty(J.LOCATION)?e[J.CAMERA][J.LOCATION].lat+","+e[J.CAMERA][J.LOCATION].long:null),getPriceRange=function(e){let t=getInheritedPropertyObject(e||h,J.SHOP);if(t&&"-"!==t.options&&t.showPriceRange){let e=t.options.split("::"),r=Number.MAX_VALUE,n=Number.MIN_VALUE;if(e.length>1){for(let t=0;t<e.length;t++)r=Math.min(parseFloat(e[t].split("=")[1].split("+")[0]),r);if("minmax"===t.showPriceRange){for(let t=0;t<e.length;t++)n=Math.max(parseFloat(e[t].split("=")[1].split("+")[0]),n);return toCurrency(r,t.currency)+"&ndash;"+toCurrency(n,t.currency)}return l.from.template(toCurrency(r,t.currency))}return toCurrency(e[0].split("=")[1].split("+")[0],t.currency)}return""},getCurrency=(()=>getRootProperty(J.SHOP).currency||"EUR"),getDeepFolderCount=function(e){let t=0,r=typeof e===UNDEF?n:e;if(r.hasOwnProperty(J.FOLDERS))if(r.hasOwnProperty(J.DEEPCOUNTERS)&&r[J.DEEPCOUNTERS].hasOwnProperty(J.FOLDERS))t=r[J.DEEPCOUNTERS][J.FOLDERS];else{for(let e=0,n=r[J.FOLDERS].length;e<n;e++)t+=getDeepFolderCount(r[J.FOLDERS][e]);r.hasOwnProperty(J.DEEPCOUNTERS)||(r[J.DEEPCOUNTERS]={}),r[J.DEEPCOUNTERS][J.FOLDERS]=t}return t+1},getFolderCount=function(e,t){let r=e[J.LEVEL]+(t||0),n=function(e){let t=0;if(e.hasOwnProperty(J.FOLDERS)&&e[J.LEVEL]<=r)for(let r=0,o=e[J.FOLDERS].length;r<o;r++)t+=n(e[J.FOLDERS][r]);return t+1};return n(e)},getRootProperty=(e=>h.hasOwnProperty(e)?h[e]:null),getInheritedPropertyObject=function(t,r){let n={};do{t.hasOwnProperty(r)&&(n=e.extend(!0,{},t[r],n))}while(t=getParent(t));return Object.getOwnPropertyNames(n).length?n:null},getInheritedProperty=function(t,r){if(r.indexOf(".")>=0){if("album"===(r=r.split("."))[0])return getRootProperty(r[1]);do{if(t.hasOwnProperty(r[0]))return e.extend(!0,{},t[r[0]][r[1]])}while(t=getParent(t));return null}do{if(t.hasOwnProperty(r))return e.extend(!0,{},t[r])}while(t=getParent(t));return null},getProperty=function(t,r,n){let o;return n?o=getInheritedProperty(t,r):r.indexOf(".")>0?(r=r.split("."),o=t.hasOwnProperty(r[0])?t[r[0]][r[1]]:null):t.hasOwnProperty(r)&&(o=t[r]),e.extend(!0,{},o)},getPropertyObject=((t,r,n)=>n?getInheritedPropertyObject(t,r):t.hasOwnProperty(r)?e.etxend(!0,{},t[r]):null),_getNextFolder=function(e){if(typeof e===UNDEF);let t=getParent(e);if(t){let r;if(t.hasOwnProperty(J.FOLDERINDEX)){if(r=t[J.FOLDERINDEX].findIndex(r=>t[J.OBJECTS][r]===e),i<t[J.FOLDERINDEX].length)return t[J.OBJECTS][t[J.FOLDERINDEX][r+1]]}else if(t.hasOwnProperty(J.FOLDERS)&&(r=t[J.FOLDERS].findIndex(t=>t===e))<t[J.FOLDERS].length)return t[J.FOLDERS][r+1]}return null},_getPreviousFolder=function(e){if(typeof e===UNDEF);let t=getParent(e);if(t){let r;if(t.hasOwnProperty(J.FOLDERINDEX)){if((r=t[J.FOLDERINDEX].findIndex(r=>t[J.OBJECTS][r]===e))>0)return t[J.OBJECTS][t[J.FOLDERINDEX][r+1]]}else if(t.hasOwnProperty(J.FOLDERS)&&(r=t[J.FOLDERS].findIndex(t=>t===e))>0)return t[J.FOLDERS][r+1]}return null},getNextFoldersFirstImage=function(e){let t=_getNextFolder();return t&&(t.hasOwnProperty(J.OBJECTS)?e.call(getFirstImage()):loadData(t,function(){e.call(function(e){if(e.hasOwnProperty(J.OBJECTS))for(let t=e[J.OBJECTS],r=0,n=t.length;r<n;r++)if(A(t[r]))return t[r]}())})),null},getPreviousFoldersLastImage=function(e){let t=_getPreviousFolder();return t&&(t.hasOwnProperty(J.OBJECTS)?e.call(getFirstImage()):loadData(t,function(){e.call(function(e){if(e.hasOwnProperty(J.OBJECTS))for(let t=e[J.OBJECTS],r=t.length-1;r>=0;r--)if(A(t[r]))return t[r]}())})),null},sortItems=function(t,r,n){if(!Array.isArray(t))return null;Array.isArray(r)||(n=r||{},r=null);let o=e.extend({sortBy:"original",reference:J.DATETAKEN,reverse:!1,foldersFirst:!0},n);switch(o.sortBy){case"random":t.sort(()=>.5-Math.random()),r&&r.sort(()=>.5-Math.random());break;case"date":let e=o.reference;o.reverse?(t.sort((t,r)=>(t.hasOwnProperty(J.DATES)?t[J.DATES][e]:t[J.FILEDATE])-r.hasOwnProperty(J.DATES)?r[J.DATES][e]:r[J.FILEDATE]),r&&r.sort((e,t)=>e[J.FILEDATE]-t[J.FILEDATE])):(t.sort((t,r)=>(r.hasOwnProperty(J.DATES)?r[J.DATES][e]:r[J.FILEDATE])-t.hasOwnProperty(J.DATES)?t[J.DATES][e]:t[J.FILEDATE]),r&&r.sort((e,t)=>t[J.FILEDATE]-e[J.FILEDATE]));break;case J.NAME:o.reverse?(t.sort((e,t)=>(""+e[J.NAME]).localeCompare(""+t[J.NAME])),r&&r.sort((e,t)=>(""+e[J.NAME]).localeCompare(""+t[J.NAME]))):(t.sort((e,t)=>(""+t[J.NAME]).localeCompare(""+e[J.NAME])),r&&r.sort((e,t)=>(""+t[J.NAME]).localeCompare(""+e[J.NAME])));break;case J.FILESIZE:o.reverse?t.sort((e,t)=>e[J.FILESIZE]-t[J.FILESIZE]):t.sort((e,t)=>t[J.FILESIZE]-e[J.FILESIZE]);break;default:o.reverse&&(t.reverse(),r&&r.reverse())}return r?o.foldersFirst?r.concat(t):t.concat(r):t},collectByPath=function(t){if(typeof t===UNDEF||!t.hasOwnProperty("paths")||!Array.isArray(t.paths)||typeof t.ready!==FUNCTION)return[];let r,n=[],o=e.extend({folder:"",levels:0,sortBy:"original",reference:"dateTaken",reverse:!1},t),a=o.paths.length,l=0,i=(getFolder(o.folder),function(){clearTimeout(r),l<a&&P("Timout collecting "+a+" items. Image set is incomplete!"),n=sortItems(n,{sortBy:o.sortBy,reference:o.reference,reverse:o.reverse}),o.ready.call(n,o)});r=setTimeout(i,25*a);for(let e=0;e<a;e++)getItem(o.paths[e],function(e){this&&typeof e!==UNDEF&&(n[e]=this,++l===a&&(clearTimeout(r),i()))},e)},collectNItem=function(t){if(typeof t===UNDEF||!t.hasOwnProperty("ready"))return;let r=e.extend({folder:"",levels:0,include:"images",max:0,sortBy:"original",sortOrder:0},t),n=[],o=[],l=getFolder(r.folder),i=r.levels?getFolderCount(l,r.levels):1,s=0,E=!l&&r.levels>1&&h.hasOwnProperty(J.FOLDERS),O=-1!==r.include.indexOf("images"),g=-1!==r.include.indexOf("folders"),d=function(e){e&&e.hasOwnProperty(J.OBJECTS)&&e[J.OBJECTS].forEach(e=>{A(e)&&n.push(e)})},f=function(e){!e||e.hasOwnProperty(J.HIDDEN)&&e.hidden||(g&&o.push(e),O&&loadData(e,d),e[J.LEVEL]<=maxLevel&&e.hasOwnProperty(J.FOLDERS)&&e[J.FOLDERS].forEach(e=>f(e)),s++)},p=function(){f(l),setTimeout(T,20)},P=function(){u=[],f(l),setTimeout(function(){u.length?e.when.apply(e,u).done(T):T()},20)},T=function(){r.max&&r.quick&&n.length+o.length>=r.max||s>=i?(n=sortItems(n,o,{sortBy:-1===r.sortOrder?"random":r.sortBy||"original",reference:r.reference||J.FILEDATE,reverse:0===r.sortOrder,foldersFirst:r.include.startsWith("folders")}),r.max&&r.max<n.length&&(n=n.slice(0,r.max)),typeof r.ready===FUNCTION&&r.ready.call(n,r)):setTimeout(T,50)};r.hasOwnProperty("quick")||(r.quick=r.max&&"original"!==r.sortBy),maxLevel=l[J.LEVEL]+r.levels,random=-1===r.sortOrder,random&&(a.sortBy="original"),E&&!c?loadDeep(p,P):P()},collectByDate=function(t){if(typeof t===UNDEF||!t.hasOwnProperty("ready"))return;let r,o,a=e.extend({sort:!0,reverse:!1,reference:J.DATETAKEN,depth:"current"},t),l=[],i="current"===a.depth?1:getDeepFolderCount("tree"===a.depth?h:n),s=0,E="tree"===a.depth&&h.hasOwnProperty(J.FOLDERS)||"subfolders"===a.depth&&n.hasOwnProperty(J.FOLDERS)&&n[J.LEVEL]<3,O=function(e){e&&e.hasOwnProperty(J.OBJECTS)&&(e[J.OBJECTS].forEach(e=>{A(e)&&(d=e[J.DATES])&&(d=d[a.reference])&&d>=r&&d<=o&&l.push(e)}),s++)},g=function(e){!e||e.hasOwnProperty(J.HIDDEN)&&e.hidden||(loadData(e,O),"current"!==a.depth&&e.hasOwnProperty(J.FOLDERS)&&e[J.FOLDERS].forEach(e=>g(e)))},f=function(){g("tree"===a.depth?h:n),setTimeout(P,20)},p=function(){u=[],g("tree"===a.depth?h:n),setTimeout(function(){u.length?e.when.apply(e,u).done(P):P()},20)},P=function(){i>s?setTimeout(P,20):(a.sort&&(l=sortItems(l,{sortBy:a.sortBy||"date",reference:a.reference||J.DATETAKEN,reverse:a.reverse||!1})),a.max&&a.max<l.length&&(l=l.slice(0,a.max)),typeof a.ready===FUNCTION&&a.ready.call(l,a))};a.hasOwnProperty("end")&&(o=a.end*ONEDAY_S),a.hasOwnProperty("start")&&(r=a.start*ONEDAY_S),a.hasOwnProperty("range")&&(null!==r?o=r+a.range*ONEDAY_S:null!==o?r=o-a.range*ONEDAY_S:(o=Math.round(new Date/1e3),r=o-a.range*ONEDAY_S)),typeof r===UNDEF&&(r=0),typeof o===UNDEF&&(o=Math.round(new Date/1e3)),E&&!c?loadDeep(f,p):p()},collectItems=function(t){if(typeof t===UNDEF||!t.hasOwnProperty("terms"))return;let r,o,i=e.extend({fields:"creator,keywords,title,comment,name,regions",types:"all",depth:"current",exact:!1,caseSensitive:!1},t),s=[],E=i.fields.split(/,\s?/),O=E.length,g=new Array(O),d=!1,f="all"===i.types,p={},P="current"===i.depth?1:getDeepFolderCount("tree"===i.depth?h:n),T=0,I="tree"===i.depth&&h.hasOwnProperty(J.FOLDERS)||"subfolders"===i.depth&&n.hasOwnProperty(J.FOLDERS)&&n[J.LEVEL]<3,A=function(e,t){let n=0;for(let o,a,l=0;l<O;l++){if(E[l].length>1){if(E[l][0]!==t)continue;o=E[l][1]}else o=E[l][0];if(JCAMERAFIELDS.indexOf(o)>=0&&e.hasOwnProperty(J.CAMERA)?typeof(a=e[J.CAMERA][o])===UNDEF&&(a=e[o]):a=o===J.NAME?(a=e.hasOwnProperty(J.ORIGINAL)?decodeURIComponent(e[J.ORIGINAL][J.PATH].getFile()):e[J.NAME]).replace(/[\.\-_]/g," "):o===J.REGIONS?e.hasOwnProperty(J.REGIONS)?JSON.parse(e[J.REGIONS]):null:e[o],typeof a!==UNDEF&&null!==a)if(g[o]&&o===J.KEYWORDS){if(i.caseSensitive)-1!==a.indexOf(r[0])&&n++;else for(let e=0,t=r[0].toLowerCase();e<a.length;e++)if(a[e].toLowerCase()===t){n++;break}}else{if(o===J.COMMENT||o.endsWith("Caption"))a=a.stripHTML();else if(o===J.REGIONS){let e=[];for(let t,r=0;r<a.length;r++)(t=a[r].split(";")[0]+"")&&e.push(t);a=e.filter(Boolean).join(" ")}else Array.isArray(a)?a=a.join(" "):a+="";a.searchTerm(r,g[o],d,i.caseSensitive)&&n++}}(d&&n===o||n)&&s.push(e)},D=function(e){if(e){if(e!==h&&(f||p.folder)&&A(e,"folder"),e.hasOwnProperty(J.OBJECTS)){let t;e[J.OBJECTS].forEach(e=>{!e.hasOwnProperty(J.FOLDERINDEX)&&(t=e[J.CATEGORY])&&(f||p[t])&&A(e,t)})}T++}},y=function(e){!e||e.hasOwnProperty(J.HIDDEN)&&e.hidden||(loadData(e,D),"current"!==i.depth&&e.hasOwnProperty(J.FOLDERS)&&e[J.FOLDERS].forEach(e=>y(e)))},m=function(){y("tree"===i.depth?h:n),setTimeout(R,20)},N=function(){u=[],y("tree"===i.depth?h:n),setTimeout(function(){u.length?e.when.apply(e,u).done(R):R()},20)},R=function(){P>T?setTimeout(R,20):(i.max&&i.max<s.length&&(s=s.slice(0,i.max)),typeof i.ready===FUNCTION&&i.ready.call(s,i))};'"'===i.terms[0]&&'"'===i.terms[i.terms.length-1]?(r=i.terms.substring(1,i.terms.length-1),!1===i.exact&&(i.exact=!0)):!1===i.exact?~(r=i.terms.replace(/\s+/g,",")).indexOf(","+l.and+",")&&(r=r.replace(new RegExp(","+l.and+",","gi"),","),d=!0):r=i.terms.trim(),r=i.exact?[r]:removeEmpty(r.split(/,\s?/)),o=r.length;for(let e,t=0;t<O;t++)E[t]=E[t].split(":"),e=E[t][1]||E[t][0],g[e]="string"==typeof i.exact?i.exact.indexOf(e)>=0:i.exact;f||("-"===i.types.charAt(0)?a.possibleTypes.forEach(e=>{-1===i.types.indexOf(e)&&(p[e]=!0)}):i.types.split(/,\s?/).forEach(e=>{p[e]=!0})),I&&!c?loadDeep(m,N):N()},collectTags=function(t){let r=e.extend({fields:"creator,keywords,folder:title,webLocation:title",types:"all",depth:"current",exact:"creator,keywords,name"},t),o=[],l=Array.isArray(r.fields)?r.fields:r.fields.split(/,\s?/),i=l.length,s="name"===r.sort,E="all"===r.types,O={},g={},d=function(e,t){let r="^",n="^",a=function(e,t){if(!e)return;let o,a;g[t]?a=[e.toString()]:(("comment"===t||t.endsWith("Caption"))&&(e=e.stripHTML()),a=e.split(/[\s,_\.\?\!\-\(\)\[\]]/),a=removeEmpty(a));for(let e=0,t=a.length;e<t;e++)(o=a[e].trim()).length<=2||-1===n.indexOf("^"+o.toUpperCase()+"^")&&(r+=o+"^",n+=o.toUpperCase()+"^")};for(let r,n,o=0;o<i;o++){if(l[o].length>1){if(l[o][0]!==t)continue;r=l[o][1]}else r=l[o][0];if(JCAMERAFIELDS.indexOf(r)>=0&&e.hasOwnProperty(J.CAMERA)?typeof(n=e[J.CAMERA][r])===UNDEF&&(n=e[r]):n=r===J.REGIONS?e.hasOwnProperty(J.REGIONS)?JSON.parse(e[J.REGIONS]):null:e[r],typeof n!==UNDEF&&null!=n)if(r===J.REGIONS)for(let e=0;e<n.length;e++)a(n[e].split(";")[0],r);else if(Array.isArray(n))for(let e=0;e<n.length;e++)a(n[e],r);else a(n,r)}r.length>1&&function(e,t){let r=t.split("^").filter(e=>e.length>2);for(let t,n,a,l=0;l<r.length;l++)n=r[l].toUpperCase(),null!==(a=getObjectPath(e))&&(o&&o.length?(t=o.findIndex(e=>e[2]===n))>=0?-1===o[t][1].indexOf(a)&&o[t][1].push(a):o.push([r[l],[a],n]):o=[[r[l],[a],n]])}(e,r)},f=function(e){if(e&&(e!==h&&(E||O.folder)&&d(e,"folder"),e.hasOwnProperty(J.OBJECTS)))for(let t,r=0,n=e[J.OBJECTS];r<n.length;r++)n[r].hasOwnProperty(J.CATEGORY)&&(t=n[r][J.CATEGORY],(E||O[t])&&d(n[r],t))},p=function(e){if(!(!e||e.hasOwnProperty(J.HIDDEN)&&e.hidden)&&(loadData(e,f),"current"!==r.depth&&e.hasOwnProperty(J.FOLDERS)))for(let t=0,r=e[J.FOLDERS].length;t<r;t++)p(e[J.FOLDERS][t])},c=function(){r.sort&&o.sort(function(e,t){return s?(""+e[2]).localeCompare(""+t[2]):t[1]-e[1]}),r.max&&r.max<o.length&&(o=o.slice(0,r.max))};u=[];for(let e,t=0;t<i;t++)l[t]=l[t].split(":"),e=l[t][1]||l[t][0],g[e]="string"==typeof r.exact?r.exact.indexOf(e)>=0:r.exact;if(!E)for(let e=0,t=a.types.split(/,\s?/);e<t.length;e++)O[t[e]]=!0;p("tree"===r.depth?h:n),typeof r.ready===FUNCTION&&(u.length?e.when.apply(e,u).done(function(){c(),r.ready.call(o,r)}):(c(),r.ready.call(o,r)))},processTemplate=function(e,t,r){let o,a,l,i,s=typeof r!==UNDEF&&r,E=t||n,h=e=>"label"===e?getLabel(E):stringVal(E[e]);if(e&&e.indexOf("${")>0)for(;l=e.match(/\$\{([\w\.|]+)\}/);){if(l[1].indexOf("|")>0)for(let e=0,t=l[1].split("|");e<t.length&&!(i=h(t[e]));e++);else i=h(l[1]);null===i&&s&&(o=l.index-1,a=o+l[0].length,o>0&&">"===e[o]&&a<sb.length-1&&"<"===e[a]&&(o=e.lastIndexOf("<",o),a=e.indexOf(">",a),o>=0&&a>=0))?e=e.slice(0,o)+e.slice(a):e=e.slice(0,l.index)+(i||"")+e.slice(l.index+l[0].length)}return e},_up="../../../../../../../../../../../../../../../../../../../../",_relativePath=function(e,t){if(typeof e===UNDEF||!e.length||"/"===e)return t||"";if(typeof t===UNDEF||!t.length||"/"===t)return _up.slice(0,3*e.split("/").length);if(e===t)return"";for(e=e.split("/"),t=t.split("/");e.length&&t.length&&e[0]===t[0];)e.shift(),t.shift();return _up.slice(0,3*e.length)+t.join("/")},_addExtras=function(){let e=function(t,r,n,o){let l=r?D(n,t[J.PATH]):"",i=r?(e=>{if(typeof e===UNDEF||!e)return 0;"/"!==e.slice(-1)&&(e+="/");let t=O.indexOf(e);return t>=0?t+1:O.push(e)})(l):0;if(t[J.LEVEL]=r,t.hasOwnProperty(J.CATEGORY)||(t[J.CATEGORY]="folder"),r&&(t[J.PARENTREF]=o),t[J.PATHREF]=i,null===s&&(t[J.RELPATH]=getRelPathRef(_relativePath(a.relPath,l))),t[J.THUMB][J.PATH].startsWith(t[J.PATH]+"/"+a.thumbsDir)&&(t[J.THUMB][J.PATH]=t[J.THUMB][J.PATH].slice(t[J.PATH].length+1)),t.hasOwnProperty(J.FOLDERS))for(let n=0,o=t[J.FOLDERS].length;n<o;n++)e(t[J.FOLDERS][n],r+1,l,i)};e(h,0,"",0)},loadTree=function(t){let r=D(s||a.rootPath,a.treeFile)+E;return e.getJSON(r).done(function(e){(h=e)[J.LOADCOUNTER]={},h[J.LOADCOUNTER][J.TOTAL]=0,a.possibleTypes.forEach(e=>{h[J.LOADCOUNTER][e]=0}),null===(n=getFolder(a.relPath))&&typeof a.fatalError===FUNCTION&&a.fatalError.call(this,"noSuchFolder",a.relPath),_addExtras(),typeof t===FUNCTION&&t.call(this)}).fail(function(e,n,o){typeof a.fatalError===FUNCTION&&a.fatalError.call(this,"databaseAccessDenied",r),typeof t===FUNCTION&&t.call(this)})},copyFolderProps=function(e,t){if(t)for(let r in e)r===J.OBJECTS||r===J.ALBUM||t.hasOwnProperty(r)||(t[r]=e[r])},copyObjects=function(e,t,r){if(e.hasOwnProperty(J.OBJECTS)){t[J.OBJECTS]=[];for(let n,o=0,a=0,l=e[J.OBJECTS].length;o<l;o++)n=e[J.OBJECTS][o],h[J.LOADCOUNTER][n[J.CATEGORY]]++,h[J.LOADCOUNTER][J.TOTAL]++,"folder"===n[J.CATEGORY]?(t[J.FOLDERS]||(t[J.FOLDERS]=[]),copyFolderProps(n,t[J.FOLDERS][a]),r&&copyObjects(n,t[J.FOLDERS][a],!0),(n={})[J.FOLDERINDEX]=a,a++):(n[J.PATHREF]=t[J.PATHREF],n[J.RELPATH]=t[J.RELPATH]),t[J.OBJECTS].push(n)}},loadData=function(t,r){if(t){if(t.hasOwnProperty(J.OBJECTS))return typeof r===FUNCTION&&r.call(this,t),!0;{let n=D(getPath(t),a.dataFile)+E;u||(u=[]),u.push(e.getJSON(n).done(function(e){copyFolderProps(e,t),copyObjects(e,t),typeof r===FUNCTION&&r.call(this,t)}).fail(function(e,o,a){P('Error loading folder data for "'+n+'": '+o+", "+a),typeof r===FUNCTION&&r.call(this,t)}))}}},loadFolder=function(e,t){if(loadData(e),t&&e.hasOwnProperty(J.FOLDERS))for(let t=0,r=e[J.FOLDERS].length;t<r;t++)loadFolder(e[J.FOLDERS][t])},loadDeep=function(t,r){c&&t.call(h);let n=new Date,o=D(s||a.rootPath,a.deepDataFile)+E;return e.getJSON(o).done(function(e){DEBUG&&(P("Deep data loaded: "+(new Date-n)+"ms total: "+h[J.LOADCOUNTER][J.TOTAL]+" objects"),n=new Date),copyObjects(e,h,!0),DEBUG&&P("Deep data objects are ready: "+(new Date-n)+"ms total: "+h[J.LOADCOUNTER][J.TOTAL]+" objects"),c=!0,typeof a.deepReady===FUNCTION&&(a.deepReady.call(this),a.deepReady=null),typeof t===FUNCTION&&t.call(this)}).fail(function(){c=!1,DEBUG&&P('Error loading deep data: "'+o+'".'),typeof a.deepReady===FUNCTION&&(a.deepReady.call(this),a.deepReady=null),typeof r===FUNCTION&&r.call(this)})},init=function(t){if(o)return o;o=new Date,typeof t!==UNDEF&&e.extend(a,t),p=c=!1,a.hasOwnProperty("albumPath")&&"/"!==(s=a.albumPath).slice(-1)&&(s+="/"),r=(e=>{if(typeof e===UNDEF)return window.location.href.substring(0,window.location.href.lastIndexOf("/"));if(e.match(/^https?\:\/\//i))return e;if("/"===e[0])return window.location.origin+e;{let t=window.location.href;for(t=t.substring(0,t.lastIndexOf("/")),e.endsWith("..")&&(e+="/");e.startsWith("../");)t=t.substring(0,t.lastIndexOf("/",t.length-2)),e=e.slice(3);return t+e}})(s||a.rootPath),a.hasOwnProperty("makeDate")&&(E="?"+a.makeDate);return loadTree(function(){u=[],loadFolder(a.lazy?n:h,!a.lazy),e.when.apply(e,u).done(function(){let e=new Date;DEBUG&&P(u.length+" folder(s) loaded: "+(e-o)+"ms"),p=!0,u=null,typeof a.ready===FUNCTION&&(a.ready.call(this),a.ready=null),a.loadDeep&&h.hasOwnProperty(J.FOLDERS)?loadDeep():typeof a.deepReady===FUNCTION&&(a.deepReady.call(this),a.deepReady=null)})})},t&&(DEBUG&&console.log("new Album("+JSON.stringify(t)+");"),init(t)),{isReady:()=>p,isDeepReady:()=>c,getTree:()=>h,isImage:e=>e.hasOwnProperty(J.CATEGORY)&&"image"===e[J.CATEGORY],isAudio:e=>e.hasOwnProperty(J.CATEGORY)&&"audio"===e[J.CATEGORY],isVideo:e=>e.hasOwnProperty(J.CATEGORY)&&"video"===e[J.CATEGORY],isLightboxable:A,isCurrentFolder:e=>e===n,getAlbumPath:getAlbumPath,getAlbumRootPath:getAlbumRootPath,getPath:getPath,getAbsolutePath:getAbsolutePath,getItemPath:getItemPath,getDimensions:getDimensions,getOriginalDimensions:getOriginalDimensions,getMaxDimensions:getMaxDimensions,getLink:getLink,getRootPath:getRootPath,getFolderPath:getFolderPath,getRelativeFolderPath:getRelativeFolderPath,getFolder:getFolder,getParent:getParent,getItem:getItem,getCurrentFolder:getCurrentFolder,getObjects:getObjects,getImages:getImages,getFolders:getFolders,getMakeDate:getMakeDate,getAlbumTitle:getAlbumTitle,getItemName:getItemName,getExtension:I,getLevel:getLevel,getTitle:getTitle,getName:getName,getLabel:getLabel,getAlt:getAlt,getComment:getComment,getThumbPath:getThumbPath,getImagePath:getImagePath,getAbsoluteImagePath:getAbsoluteImagePath,getThemeImagePath:getThemeImagePath,getOriginalPath:getOriginalPath,getPosterPath:getPosterPath,getOptimalImage:getOptimalImage,getOptimalImagePath:getOptimalImagePath,getOptimalThumbPath:getOptimalThumbPath,getSourcePath:getSourcePath,getAbsoluteItemPath:getAbsoluteItemPath,getVideoDuration:getVideoDuration,hasShop:hasShop,hasLocation:hasLocation,getLocation:getLocation,getPriceRange:getPriceRange,getCurrency:getCurrency,getDeepFolderCount:getDeepFolderCount,getRootProperty:getRootProperty,getInheritedPropertyObject:getInheritedPropertyObject,getInheritedProperty:getInheritedProperty,getProperty:getProperty,getPropertyObject:getPropertyObject,getNextFoldersFirstImage:getNextFoldersFirstImage,getPreviousFoldersLastImage:getPreviousFoldersLastImage,sortItems:sortItems,collectByPath:collectByPath,collectNItem:collectNItem,collectByDate:collectByDate,collectItems:collectItems,collectTags:collectTags,processTemplate:processTemplate}};