!function(e,t,a){"use strict";e.fn.feedback=function(t,n){if(!t)return this;if(!(n=e.extend({},e.fn.feedback.defaults,t.getRootProperty(J.FEEDBACK),n)).to)return console.log("feedback.js: no target email found"),this;var o,i,s,r,l,c,d=e(this).eq(0),f=d.data("lfb_ns"),m=e.fn.feedback.text,p=xDecrypt(n.to),u="%0D%0A",h=e(),b=e(),g=e(),v={cart:"feedback-cart",shortcut:"feedback-shortcut",window:"feedback-window",cont:"cont",beforeItems:"before-items",summary:"summary",summaryTxt:"summary-txt",details:"details",newItems:"new-items",items:"items",afterItems:"after-items",buttons:"buttons",item:"item",path:"path",file:"file",info:"info",thumb:"thumb",title:"title",data:"data",options:"options"},y={data:"feedback.cart.data",date:"feedback.cart.date"},w=DIR_PATH||"/",I=function(e,t){localStorage.setItem(w+e,t)},T=function(e){return localStorage.getItem(w+e)},k=function(e){localStorage.removeItem(w+e)},C=function(){if(LOCALSTORAGE)for(var e in y)k(y[e])},x=function(t){if(LOCALSTORAGE){var a,n={};(a=i.find("."+v.beforeItems+" form")).length&&(n.before=a.serialize()),(a=i.find("."+v.item)).length&&(n.items=new Array,a.each(function(){n.items.push(function(e){var t={path:e.data("path"),file:e.data("file"),title:e.find("."+v.title).text(),data:e.find("."+v.data+" form").serialize()};return typeof e.data("thumbFormat")!==UNDEF&&(t.thumbFormat=e.data("thumbFormat")),t}(e(this)))})),(a=i.find("."+v.afterItems+" form")).length&&(n.after=a.serialize()),isEmpty(n)?C():(n=JSON.stringify(n),I(y.data,n),I(y.date,(new Date).getTime()))}typeof t===FUNCTION&&t.call(this)},S=function(a){if(a&&a.hasOwnProperty("file")){var i,s,r;return r=a.hasOwnProperty("path")?n.hasOwnProperty("relPath")?getRelativePath(n.relPath||"/",a.path):a.path:"",r+=n.thumbsFolder,a.hasOwnProperty("thumbFormat")?r+=a.file.replaceExt(a.thumbFormat):r+=a.file,i=e("<div>",{class:v.item+" clearfix"}),(s=e("<div>",{class:v.info}).appendTo(i)).append(e("<a>",{class:"button icon-close"}).on("click."+f,function(){e(this).parents("."+v.item).remove()}).on("selectstart",function(e){return e.preventDefault(),!1})),s.append(e("<img>",{class:v.thumb,src:r})),s.append(e("<span>",{class:v.title,html:a.title})),i.append(e("<div>",{class:v.data,html:t.processTemplate(o)})),l.append(i),a.data&&i.find("form").deserialize(a.data,!0),i.data({path:a.path,file:a.file}),a.hasOwnProperty("thumbFormat")&&i.data("thumbFormat",a.thumbFormat),i}},F=function(e){var a,n={title:e[J.TITLE]||e[J.NAME]||"",path:t.getFolderPath(e),file:encodeURI(e[J.NAME])};return a=e[J.THUMB][J.PATH].getExt(),e[J.NAME].getExt()!==a&&(n.thumbFormat=a),n},O=function(e){if(e){var t=N();if(Array.isArray(e))for(var a=0;a<e.length;a++)S(F(e[a]));else S(F(e));A(),D(function(){var e=l.find("."+v.item);e.length&&(e=e.eq(t).find("input,textarea,select")).length&&e[0].focus()})}},N=function(){return r.find("."+v.item).length},A=function(e){var t=N();b.add(h).add(g).toggleClass("disabled",0===t),U(t),e||x()},U=function(t){if(n.hasOwnProperty("button")&&n.button.length)if(t){var a=n.button.children(".badge");a.length||(a=e("<span>",{class:"badge top-right"}).appendTo(n.button)),a.text(t).show()}else n.button.children(".badge").hide()},R=function(t){if(t){var a,n=[];return t.find("input,textarea,select").each(function(){null!==(a=e(this).val())&&n.push((this.name||this.id||this.nodeName)+": "+a)}),n.join(", ")}return""},P=function(e){if(e)switch(n.formatting){case"human":return e.serialize().replace(/\+/g,"%20").replace(/=/g,": ").replace(/\&/g,u);case"serialized":return(e.attr("name")||e.attr("id")||"form")+'="'+encodeURIComponent(e.serialize())+'";';default:return encodeURIComponent(R(e))}return""},E=function(){var e;return(e=r.find("."+v.beforeItems+" form")).length?P(e):""},B=function(){var t=[];return"serialized"===n.formatting?t.push("items={"):t.push(u+"----------------------"),r.find("."+v.item).each(function(a){var o=e(this),i=o.data("path")+o.data("file"),s=o.find("form").eq(0);switch(n.formatting){case"human":t.push((a?u:"")+String(a+1)+".%09"+encodeURI(i)+(s?u+"%09"+s.serialize().replace(/\+/g,"%20").replace(/=/g,": ").replace(/\&/g,",%20"):""));break;case"serialized":t.push('{file:"'+encodeURI(i)+'"'+(s?","+(s.attr("name")||s.attr("id")||"form")+':"'+encodeURIComponent(o.find("form").serialize())+'"':"")+"},");break;default:t.push(String(a+1)+".%09"+encodeURI(i)+(s?":%09"+encodeURIComponent(R(s)):""))}}),"serialized"===n.formatting?(t[t.length-1]=t[t.length-1].replace(/\,$/,""),t.push("};")):t.push("----------------------"+u),t.join(u)},z=function(){var e;return(e=r.find("."+v.afterItems+" form")).length?P(e):""},L=function(t){var n=E()+u+B()+u+z(),o=(UNDEF,e("<div>",{html:(t?'<h4 class="icon-warning"> '+m.tooLong+"</h4>":"")+'<p><textarea name="body" rows="8">'+m.to+": "+p+"\n"+m.subject+": "+s.find("header").text()+"\n\n"+decodeURIComponent(n)+'</textarea></p><p class="icon-info instructions"> '+m.copyInstructions+"</p>"}));a.modal(o,[{t:m.okButton,c:"icon-ok",h:function(){j()}}],{title:t?m.warning:m.copiedToClipboard,class:(t?"warning":"success")+" small"}),o.find("[name=body]")[0].select(),document.execCommand("copy")},_=function(){var e,t="mailto:"+encodeURIComponent(p)+"?subject="+encodeURIComponent(s.find("header").text()),a=E()+u+B()+u+z();if(DEBUG)try{console.log(decodeURIComponent(a))}catch(e){console.log(e)}(e=t+"&body="+a).length>2048?L(!0):(window.location.href=e,j()),M()},j=function(){a.modal(e("<h3>",{class:"text-center icon-warning",html:" "+m.removeAllItems}),[{t:m.yes,c:"alert icon-trash",h:function(){r.find(".item").remove(),A(),M()}},{t:m.no,h:function(){}}],{class:"alert small"})},D=function(e){i.is(":visible")||(a.addClass("no-scroll"),a.addClass("has-modal"),i.fadeIn(400,function(){r.animate({scrollTop:r[0].scrollHeight-Math.round(r.outerHeight())},400),typeof e===FUNCTION&&e.call(this)}))},M=function(t){N();i.is(":visible")&&(e("body,html").removeClass("no-scroll"),e("body").removeClass("has-modal"),i.fadeOut(400,function(){typeof t===FUNCTION&&t.call(this)}),x())};return function(p){var u,y;void 0!==f&&(e(s).off("."+f),e("#cart_"+f).remove(),e("#cart_shortcut_"+f).remove()),d.data("lfb_ns",f="lfb_"+Math.floor(1e4*Math.random())),i=e("<div>",{id:"cart_"+f,class:"modal "+v.cart,role:"modal"}).hide().appendTo(a),c=e("<div>",{id:"cart_shortcut_"+f,class:n.useShortcutButton?v.shortcut:"buttons"}).append(e("<a>",{class:"secondary button view-cart",html:" "+m.view}).on("click."+f,function(){D()})).append(e("<a>",{class:"global button disabled add-cart icon-email-send",html:" "+m.writeFeedback}).on("click."+f,function(){typeof n.getSelected===FUNCTION&&(O(n.getSelected.call()),typeof n.selectNone===FUNCTION&&n.selectNone.call())})).appendTo(d),(s=e("<div>",{class:"window has-header "+v.window,role:"dialog"}).appendTo(i)).append(e("<header>",{class:"icon-email-send",html:" <strong> "+m.feedbackOnAlbum.template(t.getAlbumTitle())+"</strong>"})),s.append(e("<a>",{class:"btn close"}).on("click."+f,M)),i.on("click."+f,function(e){return e.target.id!=="cart_"+f||(M(),!1)}),r=e("<div>",{class:"content"}).appendTo(s),(u=n.template.split(n.itemsStart)[0].trim())&&r.append(e("<div>",{class:v.beforeItems,html:t.processTemplate(u)})),l=e("<div>",{class:v.items}).appendTo(r),(u=n.template.split(n.itemsStop)).length&&(u=u[1].trim())&&r.append(e("<div>",{class:v.afterItems,html:t.processTemplate(u)})),(y=e("<div>",{class:v.buttons}).appendTo(r)).append(e("<a>",{class:"secondary button icon-arrow-left",text:" "+m.continueBrowsing}).on("click."+f,M)),g=e("<a>",{class:"alert button icon-trash",text:" "+m.removeAll}).on("click."+f,j).appendTo(y),h=e("<a>",{class:"success disabled button icon-external",html:" "+n.copyBtnLabel}).on("click."+f,function(){return L(!1),!1}).appendTo(y),n.useSendButton&&(b=e("<a>",{class:"disabled button icon-email-send",html:" "+n.sendBtnLabel}).on("click."+f,_).appendTo(y),y.after(e("<p>",{class:"fineprint",html:m.feedbackButtonExplanation}))),n.hasOwnProperty("instructions")&&n.instructions&&r.append(e("<div>",{class:"instructions icon-info"}).append(e("<div>").append(n.instructions.fixjAlbumPaths(n.resPath,n.rootPath,n.relPath)))),s.find("a.close").addTooltip(m.continueBrowsing),n.template.indexOf(n.itemsStart)>=0&&(u=n.template.split(n.itemsStart)[1].trim())&&(u=u.split(n.itemsStop)[0].trim())&&(o=u.replace(/\$\{fileName\}/g,"${name}")),typeof p===FUNCTION&&p.call(this)}(function(e){if(LOCALSTORAGE){var t,a=(new Date).getTime();if(t=T(y.date)){if(a-parseInt(t)>n.expiry)return void C();I(y.date,a)}if(t=T(y.data)){var o=JSON.parse(t);if(!isEmpty(o)){if(o.before&&i.find("."+v.beforeItems+" form").deserialize(o.before),o.items)for(var s=0;s<o.items.length;s++)S(o.items[s]);o.after&&i.find("."+v.afterItems+" form").deserialize(o.after)}}}A(!0),typeof e===FUNCTION&&e.call(this)}),d.on("addItems",function(e){var t=Array.prototype.slice.call(arguments,1);O(t)}).on("emptyCart",function(e,t){j(t)}).on("itemsSelected",function(t,a){!function(t){var a=c.find(".global.add-cart");if(t){var n=a.children(".badge");n.length||(n=e("<span>",{class:"badge red"}).appendTo(a)),n.text(t).show(),a.removeClass("disabled"),a.addTooltip(m.addSelectedItems)}else a.addClass("disabled").children(".badge").hide(),a.addTooltip(m.selectItems)}(a)}).on("showCart",function(e,t){D(t)}).on("hideCart",function(e,t){M(t)}),n.hasOwnProperty("onReady")&&n.onReady(this),this},e.fn.feedback.defaults={expiry:36e5,useShortcutButton:!1,rootPath:"",relPath:"",formatting:"human",thumbsFolder:"thumbs/",copyBtnLabel:"Copy to clipboard",sendBtnLabel:"Send feedback",useSendButton:!0,itemsStart:"\x3c!-- items:start --\x3e",itemsStop:"\x3c!-- items:stop --\x3e"},e.fn.feedback.text=getTranslations({edit:"Edit",continueBrowsing:"Continue browsing",feedback:"Feedback",sendFeedback:"Send feedback",writeFeedback:"Write feedback",addFeedbackCart:"Feedback on images",view:"View",selectItems:"Select items to add!",addSelectedItems:"Add selected items!",feedbackOnAlbum:'Feedback on album "{0}"',closeWindow:"Close window",removeAll:"Remove all",removeAllItems:"Remove all items?",yes:"Yes",no:"No",to:"To",subject:"Subject",warning:"Warning",copiedToClipboard:"Copied to clipboard!",okButton:"OK",tooLong:"This is too long to pass to the email application directly.",copyInstructions:'The text has been copied to your clipboard. Now switch to the email applicaiton or the webmail and paste it as message body. Move "To" and "Subject" into the appropriate boxes!',feedbackButtonExplanation:'Try "Send" if you have an email application installed, use "Copy" for web mail!'})}(jQuery,$(window),$("body"));