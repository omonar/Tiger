!function(e,t,a){"use strict";e.fn.feedback=function(t,n){if(!t)return this;if(!(n=e.extend({},e.fn.feedback.defaults,t.getRootProperty(J.FEEDBACK),n)).to)return console.log("feedback.js: no target email found"),this;var o,i,s,r,l,c,d=e(this).eq(0),m=d.data("lfb_ns"),f=e.fn.feedback.text,p=xDecrypt(n.to),u="%0D%0A",h=e(),b=e(),g=e(),v={cart:"feedback-cart",shortcut:"feedback-shortcut",window:"feedback-window",cont:"cont",beforeItems:"before-items",summary:"summary",summaryTxt:"summary-txt",details:"details",newItems:"new-items",items:"items",afterItems:"after-items",buttons:"buttons",item:"item",path:"path",file:"file",info:"info",thumb:"thumb",title:"title",data:"data",options:"options"},w={data:"feedback.cart.data",date:"feedback.cart.date"},y=function(){if(LOCALSTORAGE)for(var e in w)localStorage.removeItem(w[e])},I=function(t){if(LOCALSTORAGE){var a,n={};(a=i.find("."+v.beforeItems+" form")).length&&(n.before=a.serialize()),(a=i.find("."+v.item)).length&&(n.items=new Array,a.each(function(){var t=e(this);n.items.push({path:t.data("path"),file:t.data("file"),title:t.find("."+v.title).text(),data:t.find("."+v.data+" form").serialize()})})),(a=i.find("."+v.afterItems+" form")).length&&(n.after=a.serialize()),isEmpty(n)?y():(n=JSON.stringify(n),localStorage.setItem(w.data,n),localStorage.setItem(w.date,(new Date).getTime()))}e.isFunction(t)&&t.call(this)},k=function(a,i,s,r){if(i){var c,d,f=a?getRelativePath(n.relPath||"/",a):n.rootPath+"/";return c=e("<div>",{class:v.item+" clearfix"}),(d=e("<div>",{class:v.info}).appendTo(c)).append(e("<a>",{class:"button icon-cancel"}).on("click."+m,function(){e(this).parents("."+v.item).remove()}).on("selectstart",function(e){return e.preventDefault(),!1})),d.append(e("<img>",{class:v.thumb,src:f+n.thumbsFolder+"/"+i})),d.append(e("<span>",{class:v.title,html:s})),c.append(e("<div>",{class:v.data,html:t.processTemplate(o)})),l.append(c),r&&c.find("form").deserialize(r,!0),c.data({path:a,file:i}),c}},C=function(e){return k(t.getFolderPath(e),t.getThumbPath(e).getFile(),e[J.TITLE]||e[J.NAME]||"")},T=function(t){var a=x();if(t&&t.length){if(e.isArray(t))for(var n=0;n<t.length;n++)C(t[n]);else C(t);S(),L(function(){l.find("."+v.item).eq(a).find("input,textarea,select")[0].focus()})}},x=function(){return r.find("."+v.item).length},S=function(e){var t=x();b.add(h).add(g).toggleClass("disabled",0===t),F(t),!i.is(":visible")&&t&&c.fadeIn(400),e||I()},F=function(e,t){typeof t!==UNDEF&&t?c.find(".button").removeClass("view-cart").addClass("add-cart pop").html("<sup>+</sup> "+f.addComment+" <b>"+t+"</b>"):(e=0===t||typeof e===UNDEF?x():e,c.find(".button").removeClass("add-cart pop").addClass("view-cart").html(" "+f.viewFeedbackCart+(e>0?" <b>"+e+"</b>":"")))},A=function(t){if(t){var a,n=[];return t.find("input,textarea,select").each(function(){null!==(a=e(this).val())&&n.push((this.name||this.id||this.nodeName)+": "+a)}),n.join(", ")}return""},R=function(e){if(e)switch(n.formatting){case"human":return e.serialize().replace(/\+/g,"%20").replace(/=/g,": ").replace(/\&/g,u);case"serialized":return(e.attr("name")||e.attr("id")||"form")+'="'+encodeURIComponent(e.serialize())+'";';default:return encodeURIComponent(A(e))}return""},B=function(){var e;return(e=r.find("."+v.beforeItems+" form")).length?R(e):""},E=function(){var t=[];return"serialized"===n.formatting?t.push("items={"):t.push(u+"----------------------"),r.find("."+v.item).each(function(a){var o=e(this),i=o.data("path")+"/"+o.data("file"),s=o.find("form").eq(0);switch(n.formatting){case"human":t.push((a?u:"")+String(a+1)+".%09"+encodeURI(i).replace(/%/g,"%25")+(s?u+"%09"+s.serialize().replace(/\+/g,"%20").replace(/=/g,": ").replace(/\&/g,",%20"):""));break;case"serialized":t.push('{file:"'+encodeURI(i).replace(/%/g,"%25")+'"'+(s?","+(s.attr("name")||s.attr("id")||"form")+':"'+encodeURIComponent(o.find("form").serialize())+'"':"")+"},");break;default:t.push(String(a+1)+".%09"+encodeURI(i).replace(/%/g,"%25")+(s?":%09"+encodeURIComponent(A(s)):""))}}),"serialized"===n.formatting?(t[t.length-1]=t[t.length-1].replace(/\,$/,""),t.push("};")):t.push("----------------------"+u),t.join(u)},O=function(){var e;return(e=r.find("."+v.afterItems+" form")).length?R(e):""},U=function(t){var n=B()+u+E()+u+O(),o=(UNDEF,e("<div>",{html:(t?'<h4 class="icon-warning">'+f.tooLong+"</h4>":"")+'<p><textarea name="body" rows="8">'+f.to+": "+p+"\n"+f.subject+": "+s.find("header").text()+"\n\n"+decodeURIComponent(n)+'</textarea></p><p class="icon-info instructions"> '+f.copyInstructions+"</p>"}));a.modal(o,[{t:f.okButton,c:"icon-ok",h:function(){P()}}],{title:t?f.warning:f.copiedToClipboard,class:(t?"warning":"success")+" small"}),o.find("[name=body]")[0].select(),document.execCommand("copy")},z=function(){var e,t="mailto:"+encodeURIComponent(p)+"?subject="+encodeURIComponent(s.find("header").text()),a=B()+u+E()+u+O();if(DEBUG)try{console.log(decodeURIComponent(a))}catch(e){console.log(e)}(e=t+"&body="+a).length>2048?U(!0):(window.location.href=e,P()),N()},P=function(){a.modal(e("<h3>",{class:"text-center icon-warning",html:" "+f.removeAllItems}),[{t:f.yes,c:"alert icon-trash",h:function(){r.find(".item").remove(),S(),N()}},{t:f.no,h:function(){}}],{class:"alert small"})},L=function(t){i.is(":visible")||(a.addClass("no-scroll"),a.addClass("has-modal"),i.fadeIn(400,function(){e.isFunction(t)&&t.call(this),r.animate({scrollTop:r[0].scrollHeight-Math.round(r.outerHeight())},400)})),c.fadeOut()},N=function(t){x();i.is(":visible")&&(e("body,html").removeClass("no-scroll"),e("body").removeClass("has-modal"),i.fadeOut(400,function(){c.fadeIn(400),e.isFunction(t)&&t.call(this)}),I())};return function(p){var u,w;void 0!==m&&(e(s).off("."+m),e("#cart_"+m).remove(),e("#cart_shortcut_"+m).remove()),d.data("lfb_ns",m="lfb_"+Math.floor(1e4*Math.random())),i=e("<div>",{id:"cart_"+m,class:"modal "+v.cart,role:"modal"}).hide().appendTo(a),n.useFloatButton&&(c=e("<div>",{id:"cart_shortcut_"+m,class:v.shortcut}).append(e("<a>",{class:"small button icon-email view-cart"}).on("click."+m,function(){e(this).hasClass("view-cart")?L():e.isFunction(n.getSelected)&&(T(n.getSelected.call()),e.isFunction(n.selectNone)&&n.selectNone.call())})).appendTo(d)),(s=e("<div>",{class:"window has-header "+v.window,role:"dialog"}).appendTo(i)).append(e("<header>",{class:"icon-email",html:"<strong> "+f.feedbackOnAlbum.template(t.getAlbumTitle())+"</strong>"})),s.append(e("<a>",{class:"btn close"}).on("click."+m,N)),i.on("click."+m,function(e){return e.target.id!=="cart_"+m||(N(),!1)}),r=e("<div>",{class:"content"}).appendTo(s),(u=n.template.split(n.itemsStart)[0].trim())&&r.append(e("<div>",{class:v.beforeItems,html:t.processTemplate(u)})),l=e("<div>",{class:v.items}).appendTo(r),(u=n.template.split(n.itemsStop)).length&&(u=u[1].trim())&&r.append(e("<div>",{class:v.afterItems,html:t.processTemplate(u)})),(w=e("<div>",{class:v.buttons}).appendTo(r)).append(e("<a>",{class:"secondary button icon-arrow-left",text:" "+f.continueBrowsing}).on("click."+m,N)),g=e("<a>",{class:"alert button icon-trash",text:" "+f.removeAll}).on("click."+m,P).appendTo(w),h=e("<a>",{class:"success disabled button icon-external",html:" "+n.copyBtnLabel}).on("click."+m,function(){return U(!1),!1}).appendTo(w),n.useSendButton&&(b=e("<a>",{class:"disabled button icon-email",html:" "+n.sendBtnLabel}).on("click."+m,z).appendTo(w),w.append(e("<p>",{class:"fineprint",html:f.feedbackButtonExplanation}))),n.hasOwnProperty("instructions")&&n.instructions&&r.append(e("<div>",{class:"instructions icon-info"}).append(e("<div>").append(n.instructions.fixjAlbumPaths(n.resPath,n.rootPath,n.relPath)))),s.find("a.close").addTooltip(f.continueBrowsing),n.template.indexOf(n.itemsStart)>=0&&(u=n.template.split(n.itemsStart)[1].trim())&&(u=u.split(n.itemsStop)[0].trim())&&(o=u.replace(/\$\{fileName\}/g,"${name}")),e.isFunction(p)&&p.call(this)}(function(t){if(LOCALSTORAGE){var a,o=(new Date).getTime();if(a=localStorage.getItem(w.date)){if(o-parseInt(a)>n.expiry)return void y();localStorage.setItem(w.date,o)}if(a=localStorage.getItem(w.data)){var s=JSON.parse(a);if(!isEmpty(s)){if(s.before&&i.find("."+v.beforeItems+" form").deserialize(s.before),s.items)for(var r=0;r<s.items.length;r++)k(s.items[r].path,s.items[r].file,s.items[r].title,s.items[r].data);s.after&&i.find("."+v.afterItems+" form").deserialize(s.after)}}}S(!0),e.isFunction(t)&&t.call(this)}),d.on("addItems",function(e){var t=Array.prototype.slice.call(arguments,1);T(t)}).on("emptyCart",function(e,t){P(t)}).on("itemsSelected",function(e,t){!function(e){F(0,e),c.fadeIn(400)}(t)}).on("showCart",function(e,t){L(t)}).on("hideCart",function(e,t){N(t)}),n.hasOwnProperty("onReady")&&n.onReady(this),this},e.fn.feedback.defaults={expiry:36e5,useFloatButton:!0,rootPath:"",relPath:"",formatting:"human",thumbsFolder:"thumbs/",copyBtnLabel:"Copy to clipboard",sendBtnLabel:"Send feedback",useSendButton:!0,itemsStart:"\x3c!-- items:start --\x3e",itemsStop:"\x3c!-- items:stop --\x3e"},e.fn.feedback.text=getTranslations({edit:"Edit",continueBrowsing:"Continue browsing",feedback:"Feedback",sendFeedback:"Send feedback",addComment:"Add comment",viewFeedbackCart:"Feedback window",feedbackOnAlbum:'Feedback on album "{0}"',closeWindow:"Close window",removeAll:"Remove all",removeAllItems:"Remove all items?",yes:"Yes",no:"No",to:"To",subject:"Subject",warning:"Warning",copiedToClipboard:"Copied to clipboard!",okButton:"OK",tooLong:"This is too long to pass to the email application directly.",copyInstructions:'The text has been copied to your clipboard. Now switch to the email applicaiton or the webmail and paste it as message body. Move "To" and "Subject" into the appropriate boxes!',feedbackButtonExplanation:'Try "Send" if you have an email application installed, use "Copy" for web mail!'})}(jQuery,$(window),$("body"));